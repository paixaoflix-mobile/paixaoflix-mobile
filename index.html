<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PaixãoFlix TV — v3.4.9</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@clappr/player@latest/dist/clappr.min.js"></script>

<style>
:root { --primary:#e50914; --yellow:#ffc107; --bg:#000; --match:#46d369; }
* { box-sizing:border-box; font-family:'Poppins', sans-serif !important; outline:none; }
body { margin:0; background:var(--bg); color:#fff; height:100vh; overflow:hidden; }

#splash { position:fixed; inset:0; background:#000; z-index:9999; display:flex; align-items:center; justify-content:center; }
#splash img { width:240px; height:auto; }

.sidebar { width:260px; height:100vh; background:#000; display:flex; flex-direction:column; padding:20px; border-right:1px solid #222; position:fixed; left:0; top:0; z-index:1000; }
.logo-container img { width:160px; display:block; margin:0 auto; }

.search-box input { width:100%; padding:12px; background:#111; border:1px solid #333; color:#fff; border-radius:4px; margin:15px 0; }

.nav-menu { flex:1; overflow-y:auto; scrollbar-width:none; }
.nav-menu button, .btn-ep, .drop-item { 
    width:100%; padding:12px; margin-bottom:10px; background:#222; color:#fff; border:none; 
    box-shadow:0 4px #000; cursor:pointer; text-align:left; display:flex; align-items:center; 
    gap:10px; border-radius:4px; font-weight:700; font-size:14px; 
}

.focusable:focus { border:2px solid #fff !important; box-shadow: none !important; transform: none !important; }

.dropdown-container { display:none; grid-template-columns:1fr 1fr; gap:5px; padding:10px 0; }
.dropdown-container.active { display:grid; }
.drop-item { background:#1a1a1a; padding:8px; font-size:12px; text-align:center; box-shadow:0 3px #000; border-radius:4px; display: block; }

.content-area { margin-left:260px; height:100vh; overflow-y:auto; padding:30px; }
.grid { display:grid; gap:15px; grid-template-columns:repeat(5,1fr); }

.card { background:#141414; border-radius:4px; overflow:hidden; border:2px solid transparent; }
.card img { width:100%; aspect-ratio:2/3; object-fit:cover; display:block; }
.card.tv-card img { width:60px; height:60px; margin:15px auto; object-fit:contain; }

.card-info { padding:8px; text-align:center; }
.card-title { font-size:12px; font-weight:bold; line-height:1.2; display:block; min-height:30px; margin-bottom:5px; }

/* AVALIAÇÃO E ANO NA CAPA */
.card-meta { display:flex; justify-content:center; gap:8px; font-size:10px; color:var(--match); font-weight:bold; }

.btn-ep { 
    width: calc(10% - 8px) !important; min-width: fit-content; padding: 8px !important; 
    text-align: center; justify-content: center; font-size: 11px; display: flex;
}

.btn-back { border: 2px solid #fff !important; box-shadow: none !important; background: #222; }
.btn-exit { width: fit-content !important; padding: 5px 15px !important; background: rgba(229, 9, 20, 0.6) !important; font-size: 12px; color: #fff; border:none; }

#details-screen { position:fixed; inset:0; background:#000; z-index:2000; display:none; padding:40px; overflow-y:auto; }
.det-wrapper { display:grid; grid-template-columns:320px 1fr; gap:40px; }

#action-area { display: flex; justify-content: flex-start; margin: 20px 0; }
.btn-watch { width: fit-content !important; padding: 12px 20px !important; background: var(--primary); }

#player-overlay { position:fixed; inset:0; background:#000; z-index:3000; display:none; }
#player-wrapper { width:100%; height:100%; }

#resume-modal { position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:4000; display:none; align-items:center; justify-content:center; text-align:center; }

@media(max-width:768px){
    .sidebar{width:100%;height:auto;position:relative;}
    .content-area{margin-left:0;padding:10px;}
    .grid { display:flex !important; flex-wrap:wrap !important; gap:8px; justify-content:space-between; }
    .grid .card { width:30% !important; flex:none; }
    .det-wrapper{grid-template-columns:1fr;}
}
</style>
</head>

<body>

<div id="splash"><img src="https://raw.githubusercontent.com/paixaoflix-mobile/paixaoflix-mobile/refs/heads/main/logoof512.png"></div>

<div id="resume-modal">
    <div style="background:#222;padding:30px;border-radius:8px;border:2px solid var(--primary)">
        <h3>Continuar assistindo de onde parou?</h3>
        <div style="display:flex;gap:20px;justify-content:center;margin-top:20px">
            <button id="btn-resume-yes" class="focusable btn-ep" style="width:auto!important; padding:15px 30px!important">RETOMAR</button>
            <button id="btn-resume-no" class="focusable btn-ep" style="width:auto!important; padding:15px 30px!important; background:#e50914">REINICIAR</button>
        </div>
    </div>
</div>

<aside class="sidebar">
    <div class="logo-container">
        <img src="https://raw.githubusercontent.com/paixaoflix-mobile/paixaoflix-mobile/refs/heads/main/logoof512.png">
    </div>
    <div style="text-align:center;font-size:12px;margin:10px 0;">Sábado, 24 de Janeiro de 2026</div>
    <div id="json-counter" style="text-align:center;color:var(--yellow);font-size:12px;margin-bottom:10px;"></div>

    <div class="search-box">
        <input type="text" id="search" placeholder="Buscar filmes, séries..." class="focusable">
    </div>

    <nav class="nav-menu">
        <button id="btn-tv" onclick="loadM3U('canais.m3u')" class="focusable"><i class="fa-solid fa-play" style="color:var(--yellow)"></i> TV AO VIVO</button>
        <button onclick="loadM3U('kids_canais.m3u')" class="focusable"><i class="fa-solid fa-child" style="color:var(--yellow)"></i> TV KIDS</button>
        <button onclick="toggleDrop('drop-filmes')" class="focusable"><i class="fa-solid fa-film" style="color:var(--yellow)"></i> FILMES ▾</button>
        <div id="drop-filmes" class="dropdown-container"></div>
        <button onclick="toggleDrop('drop-series')" class="focusable"><i class="fa-solid fa-tv" style="color:var(--yellow)"></i> SÉRIES ▾</button>
        <div id="drop-series" class="dropdown-container"></div>
        <button onclick="loadVOD('kids_filmes.json','vod')" class="focusable"><i class="fa-solid fa-face-smile" style="color:var(--yellow)"></i> FILMES KIDS</button>
        <button onclick="loadVOD('kids_series.json','series')" class="focusable"><i class="fa-solid fa-robot" style="color:var(--yellow)"></i> SÉRIES KIDS</button>
        <button onclick="showContinue()" class="focusable" style="background:#1a1a1a"><i class="fa-solid fa-history" style="color:var(--yellow)"></i> CONTINUAR</button>
    </nav>
</aside>

<main class="content-area">
    <div class="grid" id="main-grid"></div>
</main>

<div id="details-screen">
    <div class="det-wrapper">
        <div style="text-align:center">
            <img id="det-poster" style="width:100%;border-radius:8px">
            <div id="det-meta-info" style="margin-top:15px; font-weight:700; color:var(--match)"></div>
            <button class="btn-back focusable" onclick="closeDetails()" style="width:100%;margin-top:20px;padding:12px;font-weight:700;">VOLTAR</button>
        </div>
        <div>
            <h1 id="det-title"></h1>
            <p id="det-desc" style="color:#ccc;margin:20px 0"></p>
            <div id="action-area"></div>
            <div id="ep-container" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:20px"></div>
            <h3 style="margin-top:30px;color:var(--yellow)">INDICAÇÕES</h3>
            <div class="grid" id="suggest-grid"></div>
        </div>
    </div>
</div>

<div id="player-overlay">
    <button class="focusable btn-exit" onclick="closePlayer()" style="position:absolute;top:20px;left:20px;z-index:4000;">SAIR DO VÍDEO</button>
    <div id="player-wrapper"></div>
</div>

<script>
const base="https://raw.githubusercontent.com/paixaoflix-mobile/paixaoflix-mobile/main/data/";
let cache={all:[]}, player, pendingMedia=null, lastPos=0;

window.onload=async()=>{
    const [f,s,kf,ks,t1,t2]=await Promise.all([
        fetch(base+"filmes.json").then(r=>r.json()), fetch(base+"series.json").then(r=>r.json()),
        fetch(base+"kids_filmes.json").then(r=>r.json()), fetch(base+"kids_series.json").then(r=>r.json()),
        fetch(base+"canais.m3u").then(r=>r.text()), fetch(base+"kids_canais.m3u").then(r=>r.text())
    ]);

    cache.all=[
        ...f.map(x=>({...x,m:'vod'})), ...s.map(x=>({...x,m:'series'})),
        ...kf.map(x=>({...x,m:'vod',k:1})), ...ks.map(x=>({...x,m:'series',k:1})),
        ...parseM3U(t1,false), ...parseM3U(t2,true)
    ].sort((a,b)=>(a.titulo||a.nome||'').localeCompare(b.titulo||b.nome||''));

    updateJsonCounter();
    setupDropdowns();
    setupRemote();
    setupSearch();
    setTimeout(()=>{ document.getElementById('splash').style.display='none'; document.getElementById('btn-tv').focus(); }, 1500);
};

function parseM3U(txt,isKids){
    const res=[]; const lines=txt.split('\n');
    for(let i=0;i<lines.length;i++){
        if(lines[i].includes('#EXTINF')){
            const n=lines[i].split(',')[1]?.trim(), u=lines[i+1]?.trim(), l=lines[i].match(/tvg-logo="([^"]+)"/)?.[1]||'';
            if(u)res.push({nome:n,url:u,logo:l,m:'tv',kids:isKids});
        }
    }
    return res;
}

function updateJsonCounter(){
    const total = cache.all.filter(x=>x.m!=='tv').length;
    document.getElementById('json-counter').innerHTML=`Descrição Já temos <span style="font-weight:700; color:#fff">${total}</span> títulos`;
}

function renderItem(item,target){
    const div=document.createElement('div');
    div.className=`card focusable ${item.m==='tv'?'tv-card':''}`; div.tabIndex=0;
    const meta = item.m!=='tv' ? `<div class="card-meta"><span>${item.ano||item.year||'2025'}</span><span>⭐ ${item.rating||'9.5'}</span></div>` : '';
    div.innerHTML=`<img src="${item.poster||item.logo}"><div class="card-info"><span class="card-title">${item.titulo||item.nome}</span>${meta}</div>`;
    div.onclick=()=> checkResume(item);
    target.appendChild(div);
}

function checkResume(item){
    const saved = localStorage.getItem('pos_'+(item.titulo||item.nome));
    if(saved && parseFloat(saved) > 10){
        pendingMedia = item; lastPos = parseFloat(saved);
        document.getElementById('resume-modal').style.display='flex';
        document.getElementById('btn-resume-yes').focus();
    } else { openDetails(item); }
}

document.getElementById('btn-resume-yes').onclick=()=>{ document.getElementById('resume-modal').style.display='none'; openDetails(pendingMedia, true); };
document.getElementById('btn-resume-no').onclick=()=>{ document.getElementById('resume-modal').style.display='none'; openDetails(pendingMedia, false); };

async function openDetails(item, resume=false){
    if(item.m==='tv') return play(item.url, item);
    document.getElementById('details-screen').style.display='block';
    document.getElementById('det-title').textContent=item.titulo;
    document.getElementById('det-poster').src=item.poster;
    document.getElementById('det-desc').textContent=item.desc||'Carregando informações...';
    document.getElementById('det-meta-info').textContent = `${item.ano||item.year||'2025'} • ⭐ ${item.rating||'9.5'}`;
    
    const eps=document.getElementById('ep-container'); eps.innerHTML='';
    const action=document.getElementById('action-area'); action.innerHTML='';
    
    if(item.m==='vod'){
        const b=document.createElement('button'); b.className='btn-ep btn-watch focusable'; b.textContent='ASSISTIR AGORA';
        b.onclick=()=>play(item.url, item, resume); action.appendChild(b);
    } else if(item.m==='series'){
        const meta = await fetch(`https://archive.org/metadata/${item.identificador_archive}`).then(r=>r.json());
        const files = meta.files.filter(f=>f.name.endsWith('.mp4'));
        files.forEach((f,idx)=>{
            const b=document.createElement('button'); b.className='btn-ep focusable'; b.textContent=`Ep ${idx+1}`;
            b.onclick=()=>play(`https://archive.org/download/${item.identificador_archive}/${f.name}`, item, resume); eps.appendChild(b);
        });
    }
    renderSuggest(); document.querySelector('#details-screen .focusable').focus();
}

function play(url, item, resume){
    document.getElementById('player-overlay').style.display='block';
    if(player) player.destroy();
    player = new Clappr.Player({
        source:url, parentId:'#player-wrapper', width:'100%', height:'100%', autoPlay:true,
        events: {
            onReady: ()=>{ if(resume) player.seek(lastPos); },
            onTimeUpdate: (e)=>{ localStorage.setItem('pos_'+(item.titulo||item.nome), e.current); }
        }
    });
}

function loadVOD(file,mode){
    const g=document.getElementById('main-grid'); g.innerHTML='';
    const isKids = file.includes('kids');
    cache.all.filter(x=>x.m===mode && !!x.k===isKids).forEach(i=>renderItem(i,g));
    g.querySelector('.focusable')?.focus();
}

function loadM3U(file){
    const g=document.getElementById('main-grid'); g.innerHTML='';
    const kids = file.includes('kids');
    cache.all.filter(x=>x.m==='tv' && x.kids===kids).forEach(i=>renderItem(i,g));
    g.querySelector('.focusable')?.focus();
}

function toggleDrop(id){ document.getElementById(id).classList.toggle('active'); }

function setupDropdowns(){
    const cats=["Ação","Anime","Aventura","Comédia","Crime","Documentários","Dorama","Drama","Faroeste","Ficção","Musical","Nacional","Policial","Religioso","Romance","Suspense","Terror","Adulto"];
    ['drop-filmes','drop-series'].forEach(id=>{
        const el=document.getElementById(id); const mode=id.includes('filmes')?'vod':'series';
        cats.forEach(c=>{
            const d=document.createElement('div'); d.className='drop-item focusable'; d.tabIndex=0; d.textContent=c;
            d.onclick=()=>{
                const g=document.getElementById('main-grid'); g.innerHTML='';
                cache.all.filter(x=>x.m===mode && x.genero===c).forEach(i=>renderItem(i,g));
                g.querySelector('.focusable')?.focus();
            };
            el.appendChild(d);
        });
    });
}

function setupRemote(){
    document.addEventListener('keydown',(e)=>{
        const act=document.activeElement; const focs=Array.from(document.querySelectorAll('.focusable'));
        // MAPEMANTO COMPLETO DE TECLAS (SAMSUNG, LG, ANDROID, TV BOX)
        const keys = {
            ENTER: [13, 29443, 117], BACK: [8, 461, 10009, 27],
            UP: [38, 29460, 1], DOWN: [40, 29461, 2],
            LEFT: [37, 4, 29462, 3], RIGHT: [39, 5, 29463, 4]
        };

        if(keys.ENTER.includes(e.keyCode)) act.click();
        if(keys.BACK.includes(e.keyCode)) { if(player) closePlayer(); else closeDetails(); }
        
        let next; const rA=act.getBoundingClientRect();
        const dirUP = keys.UP.includes(e.keyCode), dirDOWN = keys.DOWN.includes(e.keyCode), 
              dirLEFT = keys.LEFT.includes(e.keyCode), dirRIGHT = keys.RIGHT.includes(e.keyCode);

        focs.forEach(el=>{
            if(el===act || el.offsetParent===null) return;
            const rB=el.getBoundingClientRect(); const dX=rB.left-rA.left, dY=rB.top-rA.top;
            if(dirDOWN && dY > 5 && Math.abs(dX) < 300) { if(!next || dY < (next.getBoundingClientRect().top-rA.top)) next=el; }
            if(dirUP && dY < -5 && Math.abs(dX) < 300) { if(!next || dY > (next.getBoundingClientRect().top-rA.top)) next=el; }
            if(dirRIGHT && dX > 5 && Math.abs(dY) < 150) { if(!next || dX < (next.getBoundingClientRect().left-rA.left)) next=el; }
            if(dirLEFT && dX < -5 && Math.abs(dY) < 150) { if(!next || dX > (next.getBoundingClientRect().left-rA.left)) next=el; }
        });

        // RETORNO AO MENU LATERAL
        if(!next && dirLEFT && !act.closest('.sidebar')) next = document.getElementById('btn-tv');
        if(next) next.focus();
    });
}

function setupSearch(){
    document.getElementById('search').oninput=(e)=>{
        const v=e.target.value.toLowerCase(), g=document.getElementById('main-grid'); g.innerHTML='';
        if(!v) return;
        cache.all.filter(x=>(x.titulo||x.nome||'').toLowerCase().includes(v)).forEach(i=>renderItem(i,g));
    };
}

function renderSuggest(){
    const t=document.getElementById('suggest-grid'); t.innerHTML='';
    // INDICA TUDO MENOS TV
    cache.all.filter(x=>x.m!=='tv').sort(()=>0.5-Math.random()).slice(0,5).forEach(i=>renderItem(i,t));
}

function closeDetails(){ document.getElementById('details-screen').style.display='none'; }
function closePlayer(){ if(player) player.destroy(); document.getElementById('player-overlay').style.display='none'; }
function showContinue(){
    const g=document.getElementById('main-grid'); g.innerHTML='';
    cache.all.filter(x=>localStorage.getItem('pos_'+(x.titulo||x.nome))).forEach(i=>renderItem(i,g));
    g.querySelector('.focusable')?.focus();
}
</script>
</body>
</html>
